dist: xenial
language: node_js
node_js: 11
install:
 - make js_build
script:
 - python3 -m tests.server &
 - ./runtests.sh
git:
  depth: false
matrix:
  include:
    - name: "@wq/app"
      env: PACKAGE=app
    - name: "@wq/chart"
      env: PACKAGE=chart
    - name: "@wq/jest-env-jsdom-idb"
      env: PACKAGE=jest-env-jsdom-idb
    - name: "@wq/jquery-mobile"
      env: PACKAGE=jquery-mobile
    - name: "@wq/map"
      env: PACKAGE=map
    - name: "@wq/markdown"
      env: PACKAGE=markdown
    - name: "@wq/model"
      env: PACKAGE=model
    - name: "@wq/outbox"
      env: PACKAGE=outbox
    - name: "@wq/router"
      env: PACKAGE=router
    - name: "@wq/store"
      env: PACKAGE=store
    - name: "@wq/template"
      env: PACKAGE=template
    - name: "wq.app PyPI Package"
      language: python
      python: 3.7
      install:
        - pip install --upgrade pip
        - python setup.py bdist_wheel
        - pip install dist/*.whl
      script:
        - cd tests
        - mkdir css && wq init && wq scss --indir scss --outdir css
        - cd commands
        - ./test_commands.sh
      before_deploy:
        - pip install setuptools_scm
        - cd ../..
        - git checkout .
        - python3 -m tests.bintray > dist/bintray.json
      deploy:
        provider: bintray
        file: dist/bintray.json
        skip_cleanup: true
        user: "$BINTRAY_USER"
        key: "$BINTRAY_KEY"
      after_deploy:
        - sleep 20
        - WHEEL=`cd dist && ls *.whl | tail -n 1 && cd ..`
        - "curl -X PUT -H 'Content-Type: application/json' -u $BINTRAY_USER:$BINTRAY_KEY https://api.bintray.com/file_metadata/wq/wq.app/$WHEEL -d '{\"list_in_downloads\": true}'"
    - name: "JavaScript Lint"
      install: npm install
      script: npm run lint
    - name: "Python Lint"
      language: python
      python: 3.7
      install: pip install flake8
      script: flake8 build/*.py tests/*.py

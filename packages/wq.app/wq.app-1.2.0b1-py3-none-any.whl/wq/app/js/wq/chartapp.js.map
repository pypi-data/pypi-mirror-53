{"version":3,"file":"chartapp.js","sources":["../../node_modules/@wq/chart/src/chartapp.js"],"sourcesContent":["import * as d3 from 'd3';\nimport chart from './chart';\nimport pandas from './pandas';\nimport tmpl from '@wq/template';\n\n// Exported module variable\nvar chartapp = {\n    name: 'chartapp',\n    config: {\n        id_template: null,\n        label_template: null,\n        point_label_template: null,\n        width: 700,\n        height: 300,\n        point_cutoff: 50,\n        timeseries_columns: {\n            x: 'date',\n            y: 'value'\n        },\n        time_format: '%Y-%m-%d',\n        scatter_columns: {\n            x: null,\n            y: null\n        }\n    }\n};\n\nchartapp.init = function(conf) {\n    chartapp.config = { ...chartapp.config, conf };\n};\n\nvar customTypes = {};\nchartapp.addType = function(name, method, base) {\n    if (!base) {\n        base = 'base';\n    }\n    function makePlot() {\n        var plot = chart[base]();\n        if (method) {\n            method(plot);\n        }\n        return plot;\n    }\n    chart[name] = makePlot;\n    customTypes[name] = base;\n};\n\n// wq/app.js plugin\nchartapp.run = function($page) {\n    var $svg = $page.find('svg[data-wq-url]');\n    if (!$svg.length) {\n        return;\n    }\n    var type = $svg.data('wq-type'),\n        url = $svg.data('wq-url');\n    if (!type || !url) {\n        return;\n    }\n    if (!chart[type]) {\n        console.warn('Unknown chart type ' + type + '!');\n        return;\n    }\n\n    pandas.get(url, function(data) {\n        return chartapp.create(data, type, $svg[0]);\n    });\n};\n\nchartapp.create = function(data, type, elem) {\n    var plot = chart[type](),\n        baseType = customTypes[type] || type,\n        sel = d3.select(elem),\n        conf = function(name, parentName) {\n            var attrId = 'data-wq-' + name.replace(/_/g, '-'),\n                root = chartapp.config,\n                obj = parentName ? root[parentName] : root;\n            return sel.attr(attrId) || obj[name];\n        },\n        id = conf('id_template'),\n        label = conf('label_template'),\n        pointLabel = conf('point_label_template'),\n        timeseriesX = conf('x', 'timeseries_columns'),\n        timeFormat = conf('time_format'),\n        timeseriesY = conf('y', 'timeseries_columns'),\n        scatterX = conf('x', 'scatter_columns'),\n        scatterY = conf('y', 'scatter_columns'),\n        pointCutoff = conf('point_cutoff'),\n        width = conf('width'),\n        height = conf('height'),\n        keys;\n\n    if ((!id || !label) && data.length) {\n        keys = Object.keys(data[0])\n            .filter(function(key) {\n                return key != 'data';\n            })\n            .map(function(key) {\n                return '{{' + key + '}}';\n            })\n            .sort();\n        if (!id) {\n            id = keys.join('-');\n        }\n        if (!label) {\n            label = keys.join(' ');\n        }\n    }\n    if (label.indexOf('[[') > -1 && label.indexOf('{{') == -1) {\n        label = '{{=[[ ]]=}}' + label;\n    }\n\n    plot.id(function(dataset) {\n        return tmpl.render(id, dataset);\n    })\n        .label(function(dataset) {\n            return tmpl.render(label, dataset);\n        })\n        .width(width)\n        .height(height);\n\n    if (baseType == 'scatter' || baseType == 'timeSeries') {\n        plot.pointCutoff(pointCutoff);\n        if (pointLabel) {\n            if (\n                pointLabel.indexOf('[[') > -1 &&\n                pointLabel.indexOf('{{') == -1\n            ) {\n                pointLabel = '{{=[[ ]]=}}' + pointLabel;\n            }\n            plot.pointLabel(function(sid) {\n                /* eslint no-unused-vars: off */\n                return function(d) {\n                    return tmpl.render(pointLabel, d);\n                };\n            });\n        }\n    }\n\n    if (baseType == 'boxplot') {\n        plot.xvalue(function(d) {\n            var prefix = plot.prefix(),\n                key = Object.keys(d).filter(function(key) {\n                    return key.indexOf(prefix) == -1;\n                })[0];\n            return d[key];\n        });\n    } else if (baseType == 'scatter') {\n        if ((!scatterX || !scatterY) && data.length) {\n            var firstPoint = (data[0].data || [{}])[0] || {};\n            keys = Object.keys(firstPoint)\n                .filter(function(key) {\n                    return key != 'date';\n                })\n                .sort();\n            scatterX = keys[0];\n            scatterY = keys[1];\n        }\n        plot.xField(scatterX);\n        plot.yField(scatterY);\n    } else if (baseType == 'timeSeries') {\n        plot.xField(timeseriesX);\n        plot.timeFormat(timeFormat);\n        plot.yField(timeseriesY);\n    }\n\n    sel.datum(data).call(plot);\n};\n\nexport default chartapp;\n"],"names":["chartapp","name","config","id_template","label_template","point_label_template","width","height","point_cutoff","timeseries_columns","x","y","time_format","scatter_columns","init","conf","customTypes","addType","method","base","makePlot","plot","chart","run","$page","$svg","find","length","type","data","url","console","warn","pandas","get","create","elem","baseType","sel","d3","parentName","attrId","replace","root","obj","attr","id","label","pointLabel","timeseriesX","timeFormat","timeseriesY","scatterX","scatterY","pointCutoff","keys","Object","filter","key","map","sort","join","indexOf","dataset","tmpl","render","sid","d","xvalue","prefix","firstPoint","xField","yField","datum","call"],"mappings":"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"}
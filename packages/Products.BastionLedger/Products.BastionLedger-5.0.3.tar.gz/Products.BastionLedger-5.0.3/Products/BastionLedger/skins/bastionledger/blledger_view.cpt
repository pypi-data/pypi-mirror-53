<html xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      metal:use-macro="context/main_template/macros/master"
      i18n:domain="bastionledger">

  <metal:border fill-slot="top_slot">
    <tal:border define="dummy python:request.set('enable_border',1)" />
  </metal:border>
 
  <metal:calendar fill-slot="javascript_head_slot">
    <style type="text/css" media="all"
            tal:content="string:@import url(${context/portal_url}/jscalendar/calendar-system.css);"></style>
    <script type="text/javascript"
            tal:attributes="src string:${context/portal_url}/jscalendar/calendar_stripped.js"></script>
    <script type="text/javascript" charset="iso-8859-1"
            tal:condition="exists: context/jscalendar/calendar-en.js"
            tal:attributes="src string:${context/portal_url}/jscalendar/calendar-en.js"></script>
  </metal:calendar>

<body>
  <div metal:fill-slot="main"
       tal:define="ceiling_date python: modules['Products.BastionLedger.utils'].ceiling_date;
                   now  python: ceiling_date(DateTime());
                   editmode python: context.SecurityCheckPermission(context.isGeneralLedger() and 'BastionLedger: Manage' or 'BastionLedger: Operate');
                   currency_tool python: context.portal_bastionledger;
                   utool context/@@plone_portal_state/portal_url;
                   date python: request.get('date', None) and DateTime(request['date']) or now;
                   date2 python: request.get('date2', None) and DateTime(request['date2']) or None;
                   effective python: date and ceiling_date(date) or None;
                   currency request/currency | context/defaultCurrency;
                   catalog context/bastionLedger;
                   global total python: modules['Products.BastionBanking.ZCurrency'].ZCurrency(currency,0);
                   global total2 python: modules['Products.BastionBanking.ZCurrency'].ZCurrency(currency,0);
                   mq python:modules['ZTUtils'].make_query;
                   Batch python:modules['Products.CMFPlone'].Batch;
                   b_size request/b_size | python:100;
                   b_start request/b_start | python: 0;
		   sort_on request/sort_on | string:accno;
                   accounts python: context.accountValues(REQUEST=request, sort_on=sort_on);
                   batch python: Batch(accounts, int(b_size), int(b_start), orphan=1)">
 
      <h1><img src="" alt="" tal:define="icon python:context.getIcon(1)" 
               tal:attributes="src string:${utool}/${icon}">&nbsp;
          <span tal:replace="context/Title | context/getId"/> as at 
          <span tal:replace="python: (date or now).strftime('%d %B %Y')"/></h1>

       <form action="" name="edit_form" method="post" tal:attributes="action template/getId"
             metal:define-macro="filter"
             class="visualNoPrint">

          <span class="reviewHistory">
             <dl id="searching" class="collapsible inline collapsedOnLoad">
                 <dt class="collapsibleHeader">Details</dt>
                 <dd class="collapsibleContent">
                     <table summary="">
                        <tr>
                           <th>Total Accounts</th>
                           <td tal:content="context/numberAccounts"/>
                         </tr>
                        <tal:subsidiary tal:condition="not: context/isGeneralLedger">
                           <tr>
                               <th valign="top">Control Account</th>
                               <td><div tal:repeat="control context/controlAccounts">
                                       <img src="" tal:attributes="src string:${utool}/blaccount.gif"/>
                                       <a tal:attributes="href control/absolute_url"
                                          tal:content="control/prettyTitle"/>
                                   </div>
                               </td>
                            </tr>
                           <tr>
                               <th>Account Type</th>
                               <td tal:content="context/accountType"/>
                            </tr>
                        </tal:subsidiary>
                        <tr>
                           <th>Supported Currencies</th>
                           <td tal:content="python: ' '.join(context.currencies)"/>
                        </tr>
                        <tr tal:define="email context/correspondenceEmail | nothing"
                            tal:condition="email">
                           <th>Email</th>
                           <td><a href="" 
                                  tal:attributes="href string:mailto:${email}"
                                  tal:content="email"/>
                           </td>
                        </tr>
                        <tr tal:define="txn context/lastTransaction"
                            tal:condition="nocall: txn">
                           <th>Last Transaction Date</th>
                           <td tal:content="python: context.toLocalizedTime(txn.effective_date, long_format=0)"/>
                        </tr>
                      </table>
                  </dd>
             </dl>
          </span>

          <span class="reviewHistory">
            <dl id="searching" class="collapsible inline collapsedOnLoad">
              <dt class="collapsibleHeader">Filter</dt>
              <dd class="collapsibleContent"
                  tal:define="type request/type | nothing;
                              subtype request/subtype | nothing">
                <table summary="">
                          <tr>
                            <td colspan="3">
                              <div class="label">Account No.</div>
                              <textarea name="accno:tokens:ignore_empty" rows="1" 
                                        tal:content="python: ' '.join(request.get('accno', []))"/>
                            </td>
                          </tr>
                   <tr>
                     <td colspan="3" nowrap valign="top">
                        <table summary="">
                            <tr>
                                <td class="label">As at</td>
                                <td  tal:define="inputvalue date;
                                                 formname string:edit_form;
                                                 show_hm python: False;
                                                 inputname string:date;">
                                    <span metal:use-macro="here/calendar_macros/macros/calendarDatePickerBox"/>
                                </td>
                            </tr>
                            <tr>
                                <td/>
                                <td  tal:define="inputvalue date2;
                                                 formname string:edit_form;
                                                 show_hm python: False;
                                                 inputname string:date2;">
                                    <span metal:use-macro="here/calendar_macros/macros/calendarDatePickerBox"/>
                                </td>
                            </tr>
                        </table>
                     </td>
                   </tr>
                   <tr>
                     <td valign="top"
                         tal:define="types python: catalog.uniqueValuesFor('type');
                                     type request/type | nothing;"
                         tal:condition="python: len(types) > 2">
                        <div class="label">Type</div>
                        <select name="type:tokens:ignore_empty" multiple size="3">
                            <option tal:repeat="v types"
                                    tal:content="v"
                                    tal:attributes="selected python: type and type==v and 1 or 0"/>
                        </select>
                     </td>
                     <td valign="top"
                         tal:define="subtypes python: catalog.uniqueValuesFor('subtype');
                                     subtype request/subtype | nothing;"
                         tal:condition="python: len(subtypes) > 2">
                        <div class="label">SubType</div>
                        <select name="subtype:tokens:ignore_empty" multiple size="3">
                            <option tal:repeat="v subtypes"
                                    tal:content="v"
                                    tal:attributes="selected python: subtype and subtype==v and 1 or 0"/>
                        </select>
                     </td>
                     <td valign="top"
                         tal:define="status request/status | nothing;">
                        <div class="label">Status</div>
                        <select name="status:tokens:ignore_empty" multiple size="3">
                            <option tal:repeat="v context/blAccountStatuses"
                                    tal:content="v"
                                    tal:attributes="selected python: status and status==v and 1 or 0"/>
                        </select>
                     </td>
                   </tr>
                   <tr>
                     <td valign="top" colspan="3">
                        <div class="label">Text</div>
                        <textarea name="SearchableText:ignore_empty" value="" rows="1"
                               tal:content="request/SearchableText | nothing"></textarea>
                     </td>
                   </tr>
                   <tr>
			    <td valign="top">
                              <span class="label">Batch Size</span>
                              <input type="text" name="b_size:int" align="right" size="4" maxlength="4" 
                                     tal:attributes="value b_size"/>
			    </td>
			    <td valign="top">&nbsp;</td>
                     <td  valign="top" align="right">
                        <input class="context" type="submit" name="form.button.Search" value=" Search "/>
                     </td>
                 </table>
               </dd>
             </dl>
          </span>

       </form>

        <br/>

        <!-- Navigation -->
        <div metal:use-macro="context/batch_macros/macros/navigation" />

        <tal:chart metal:define-macro="chart">

       <form action="" name="action_form" method="post" tal:attributes="action template/getId">

        <table summary="" border="0" width="100%" cellpadding="2" cellspacing="0" 
               tal:condition="batch">
           <tr class="row">
               <td class="field">&nbsp;</td>
               <td class="field"></td>
               <td class="field">
                   <strong tal:condition="python: sort_on=='accno'">Number</strong>
                   <a tal:condition="python: sort_on != 'accno'"
                      tal:define="qs python: mq(request.form, sort_on='accno')"
                      href="" tal:attributes="href string:view?${qs}"
                      title="sort on Number"
                      i18n:attributes="title sort_on_accno;"><strong>Number</strong></a>
               </td>
               <td class="field"><strong>Cur.</strong></td>
               <td class="field">
                   <strong tal:condition="python: sort_on=='created'">Opened</strong>
                   <a tal:condition="python: sort_on != 'created'"
                      tal:define="qs python: mq(request.form, sort_on='created')"
                      href="" tal:attributes="href string:view?${qs}"
                      title="sort on Opened"
                      i18n:attributes="title sort_on_opened;"><strong>Opened</strong></a>
	       </td>
               <td width="40%" class="field"><strong>Description</strong></td>
               <td class="field">
                   <strong tal:condition="python: sort_on=='type'">Type</strong>
                   <a tal:condition="python: sort_on != 'type'"
                      tal:define="qs python: mq(request.form, sort_on='type')"
                      href="" tal:attributes="href string:view?${qs}"
                      title="sort on Type"
                      i18n:attributes="title sort_on_type;"><strong>Type</strong></a>
               </td>
               <td class="field">
                   <strong tal:condition="python: sort_on=='subtype'">Sub-Type</strong>
                   <a tal:condition="python: sort_on != 'subtype'"
                      tal:define="qs python: mq(request.form, sort_on='subtype')"
                      href="" tal:attributes="href string:view?${qs}"
                      title="sort on SubType"
                      i18n:attributes="title sort_on_subtype;"><strong>Sub-Type</strong></a>
               </td>
               <td class="field">
                   <strong tal:condition="python: sort_on=='status'">Status</strong>
                   <a tal:condition="python: sort_on != 'status'"
                      tal:define="qs python: mq(request.form, sort_on='status')"
                      href="" tal:attributes="href string:view?${qs}"
                      title="sort on Status"
                      i18n:attributes="title sort_on_status;"><strong>Status</strong></a>
               </td>
               <td class="field" align="right">
                   <strong tal:condition="not: date2">Balance</strong>
                   <strong tal:condition="date2" tal:content="python: date.strftime('%Y/%m/%d')"/>
               </td>
     	       <td class="field" align="right" tal:condition="date2">
                   <strong tal:content="python: date2.strftime('%Y/%m/%d')"/>
               </td>
           </tr>
           <tr tal:repeat="account batch" class=""
               tal:attributes="class python: repeat['account'].odd() and 'odd' or 'even'">
               <td class="field">
                  <input class="visualNoPrint" type="checkbox" name="ids:list" value="" 
                         tal:attributes="value account/getId">
               </td>
               <td class="field">
                   <img class="visualNoPrint" src="" title="Account"
                        tal:define="icon python:account.getIcon(1)" 
                        tal:attributes="src string:${utool}/${icon}"/>
               </td>
               <td class="field">
                   <a href="" tal:attributes="href account/getId"  
                              tal:content="account/accno"/>
               </td>
               <td class="field" tal:content="account/base_currency"/>
               <td class="field" tal:content="python: account.opened.strftime('%Y/%m/%d')"/>
               <td class="field" nowrap>
                   <a href="" tal:attributes="href account/getId"  
                              tal:content="account/title"/>
               </td>
               <td class="field" tal:content="account/type"/>
               <td class="field" nowrap tal:content="account/subtype"/>
               <td class="field" nowrap tal:content="account/status"/>
               <tal:balances tal:define="bal1 python: account.balance(effective=date);">
                  <td class="field" align="right" nowrap tal:content="bal1"/> 
                  <tal:diff tal:define="global total python: total+account.balance(effective=date, currency=currency)"
                            tal:condition="date2">
                       <td align="right" nowrap 
                           tal:define="bal2 python: account.balance(effective=date2)">
                            <i tal:attributes="style python: bal1 != bal2 and 'color: red' or ''" tal:content="bal2" 
                               tal:define="global total2 python: total2+account.balance(effective=date2, currency=currency)"/>
                       </td>
                  </tal:diff>
               </tal:balances>
           </tr>
           <tal:block tal:condition="accounts">
              <tr class="row">
                 <td colspan="11"><hr/></td>
              </tr>
              <tr class="row">
                 <td class="field" colspan="8">
                    <div class="visualNoPrint" tal:condition="editmode">
                        <input class="standalone"  type="submit"
                               name="form.button.Delete"
                               value=" Delete " i18n:attributes="value" />
                    </div>
                 </td>
                 <td class="field"  align="right"><strong>Total</strong></td>
                 <td class="field" align="right" nowrap tal:content="total"/>
                 <td tal:condition="date2" class="field" align="right" nowrap>
                    <i tal:content="total2"/>
                 </td>
              </tr>
           </tal:block>
          </table>

             <input type="hidden" name="form.submitted" value="1"/>
          </form>
        </tal:chart>


        <!-- Navigation -->
        <div metal:use-macro="context/batch_macros/macros/navigation" />

        <div class="formHelp" tal:condition="not: batch">There are no accounts for this criteria</div>

     <div tal:replace="structure provider:plone.belowcontentbody">
           Document actions (print, sendto etc)
      </div>

  </div>
 
</body>
</html>

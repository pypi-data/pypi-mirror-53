<html tal:replace="structure context/manage_page_header"
      tal:define="foo python:context.saveSearch(request);"/>

<script type="text/javascript">
<!-- 

isSelected = false;

function toggleSelect() {
  if (isSelected == false) {
    for (i = 0; i < document.objectItems.length; i++)
      document.objectItems.elements[i].checked = true ;
    isSelected = true;
    document.objectItems.selectButton.value = "Deselect All";
    return isSelected;
  }
  else {
    for (i = 0; i < document.objectItems.length; i++)
      document.objectItems.elements[i].checked = false ;
    isSelected = false;
    document.objectItems.selectButton.value = "Select All";
    return isSelected;       
  }
}

function doJournal() {
  document.objectItems.journal.value = "1";
}
function undoJournal() {
  document.objectItems.journal.value = "";
}

//-->
</script>

    <span tal:replace="structure context/manage_tabs"/>

    <tal:main tal:define="isLedger python: context.meta_type == 'Ledger';
                          utool context/@@plone_portal_state/portal_url;
journal request/journal | nothing;
			 sort_on request/sort_on | string:effective;
			 sort_order request/sort_order | string:descending;
			 batchsize request/batchsize;
                         transactionId python: request.get('transactionId', []) + request.get('ids', []);
			 accountId python: request.get('accountId', []);
                         foo python: transactionId and request.set('transactionId', transactionId);
                         entries python: journal and context.entryValues(REQUEST=request, sort_on=sort_on, sort_order=sort_order) or context.transactionValues(REQUEST=request, sort_on=sort_on, sort_order=sort_order);
                         entries_start request/entries_start | python:0;
                         now python: DateTime();
                         catalog context/bastionLedger;
                         effective_dates python:  request.get('effective', (DateTime(0), now));
                         effective_dates python: len(effective_dates) == 1 and (effective_dates[0], now) or effective_dates; 
                         effective_start python: effective_dates[0].strftime('%Y/%m/%d');
                         effective_end python: effective_dates[1].strftime('%Y/%m/%d');
                         mq python:modules['ZTUtils'].make_query;
                         batch python:modules['ZTUtils'].Batch(entries, batchsize, entries_start, orphan=2)">

       <table border="0" width="100%" cellspacing="0" cellpadding="0"
              tal:define="products context/filtered_meta_types">
          <tr>
              <td align="left">
                 <p class="help-text"><i><span tal:replace="context/getId"/> contains 
                    <span tal:replace="context/numberTransactions"/> Transactions</i></p>
              </td>
              <td align="right" valign="top" class="form-element">
                 <form method="get" action="" tal:attributes="action request/URL1">
                     <div tal:condition="python: len(products) > 1">
                         <select class="form-element" name=":action"
                                 onchange="" tal:attributes="onchange string:location.href='${request/URL1}/'+this.options[this.selectedIndex].value">
                             <option value="manage_workspace" disabled>Select type to add...</option>
                             <option tal:repeat="product products"
                                     value="" tal:attributes="value product/action"
                                     tal:content="product/name"/>
                          </select>
                          <input class="form-element" type="submit" value=" Add ">
                      </div>
                      <div tal:condition="python: len(products) == 1" tal:omit-tag="">
                         <div tal:define="product python:products[0]" tal:omit-tag="">
                             <input type="hidden" name=":method" value="" tal:attributes="value product/action"/>
                             <input class="form-element" type="submit" name="submit" value=""
                                    tal:attributes="value string: Add ${product/name}" />
                         </div>
                      </div>
                 </form>
              </td>
          </tr>
       </table>
       <br/>
       <form action="" name="objectItems" method="post" tal:attributes="action request/URL1">
       <table border="0" cellpadding="2" cellspacing="0">
          <tr>
                <td class="form-label">From</td>
                <td class="form-label">To</td>
                <td class="form-label" tal:condition="isLedger">Ledger</td>
                <td class="form-label">Entered By</td>
                <td class="form-label">Status</td>
                <td class="form-label">Tags</td>
                <td class="form-label">Account No.</td>
		<td class="form-label">Transaction No.</td>
                <td class="form-label">Text</td>
                <td class="form-label">Batch Size</td>
          </tr>
          <tr>
             <td valign="top">
                 <input class="form-element"  type="text" name="effective:ignore_empty:list:date" size="12"
                        tal:attributes="value effective_start | nothing"/>
             </td>
             <td valign="top">
                 <input type="hidden" name="effective_range" value="min:max"/>
                 <input type="hidden" name="sort_on" value="effective"/>
                 <input type="hidden" name="sort_order" value="descending"/>
                 <input class="form-element"  type="text" name="effective:ignore_empty:list:date" size="12"
                        tal:attributes="value effective_end | nothing"/>
             </td>
             <td valign="top" tal:condition="isLedger">
                 <select name="ledgerId:list:ignore_empty" multiple size="2">
                     <option tal:repeat="by python: catalog.uniqueValuesFor('ledgerId')"
                             tal:content="by"
                             tal:attributes="selected python: by in request.get('ledgerId',[]) and 1 or 0"/>
                 </select>
             </td>
             <td valign="top">
                 <select name="entered_by:list:ignore_empty" multiple size="2">
                     <option tal:repeat="by python: catalog.uniqueValuesFor('entered_by')"
                             tal:content="by"
                             tal:attributes="selected python: by in request.get('entered_by',[]) and 1 or 0"/>
                 </select>
             </td>
             <td valign="top">
                 <select name="status:list:ignore_empty" multiple size="2">
                     <option tal:repeat="status context/blTransactionStatuses"
                             tal:content="status"
                             tal:attributes="selected python: status in request.get('status',[]) and 1 or 0"/>
                 </select>
             </td>
             <td valign="top" tal:define="tags python: catalog.uniqueValuesFor('tags')"
                 tal:condition="tags">
                 <select name="tags:list:ignore_empty" multiple size="2">
                     <option tal:repeat="tag tags"
                             tal:content="tag"
                             tal:attributes="selected python: tag in request.get('tags',[]) and 1 or 0"/>
                 </select>
             </td>
             <td valign="top">
                 <textarea class="form-element" rows="2" cols="20" 
                           name="accountId:tokens:ignore_empty" 
                           tal:content="python: '\n'.join(accountId)"></textarea>
             </td>
             <td valign="top">
                 <textarea class="form-element" rows="2" cols="20" 
                           name="transactionId:tokens:ignore_empty" 
                           tal:content="python: ' '.join(transactionId)"></textarea>
             </td>
             <td valign="top">
                 <textarea class="form-element" rows="2" cols="20" 
                           name="SearchableText:ignore_empty" 
                           tal:content="request/SearchableText|nothing"></textarea>
             </td>
             <td valign="top">
                 <input class="form-element" type="text" name="batchsize:int" size="3" maxlength="3"
                        tal:attributes="value batchsize"/>
             </td>
          </tr>
          <tr>
             <td colspan="7">
                 <input class="form-element" type="submit" value=" Search " 
                        name="manage_transactions:method"/>
                 <input type="hidden" name="journal" value=""/>
                 <input class="form-element" type="submit" value="Journal View" name="manage_transactions:method"
                        onclick="doJournal(); return true"
                        tal:condition="not: journal"/>
                 <input class="form-element" type="submit" value="Transaction View" name="manage_transactions:method" 
                        onclick="undoJournal(); return true"
                        tal:condition="journal"/>
             </td>
           </tr>
       </table>

       <table border="0" cellpadding="2" cellspacing="0" width="100%" tal:condition="entries">
           <tr class="list-header">
              <td class="list-item" tal:define="p batch/previous" align="left" nowrap colspan="2">
                   <div tal:omit-tag="" tal:condition="p">
                      <a href=""
                         tal:define="qs python: mq(request.form, entries_start=p.first)"
                         tal:attributes="href python: 'manage_transactions?%s' %  qs">
                      &larr;
                      </a>
                   </div>
                   <div tal:condition="not: p" tal:omit-tag="">&nbsp;</div>
               </td>
               <td class="list-item">
                   <strong>Effective</strong>
                   <a tal:condition="python: sort_on != 'effective' or sort_order != 'descending'"
                      href="" tal:attributes="href python: 'manage_transactions?%s' % mq(request.form, sort_on='effective', sort_order='descending')">&#9660;</a>
                   <a tal:condition="python: sort_on != 'effective' or sort_order != 'ascending'"
                      href="" tal:attributes="href python: 'manage_transactions?%s' % mq(request.form, sort_on='effective', sort_order='ascending')">&#9650;</a>
               </td>
               <td class="list-item">
                   <strong tal:condition="python: sort_on=='id'">Txn No.</strong>
                   <a tal:condition="python: sort_on != 'id'"
                      tal:define="qs python: mq(request.form, sort_on='id')"
                      href="" tal:attributes="href string:manage_transactions?${qs}">Txn No.</a>
               </td>
               <td class="list-item" tal:condition="isLedger">
                   <strong tal:condition="python: sort_on=='ledgerId'">Ledger</strong>
                   <a tal:condition="python: sort_on != 'ledgerId'"
                      tal:define="qs python: mq(request.form, sort_on='ledgerId')"
                      href="" tal:attributes="href string:manage_transactions?${qs}">Ledger</a>
               </td>
               <td class="list-item" tal:condition="journal">
                   <strong>Account</strong>
               </td>
               <td class="list-item">Description</td>
               <td class="list-item">
                   <strong tal:condition="python: sort_on=='status'">Status</strong>
                   <a tal:condition="python: sort_on != 'status'"
                      tal:define="qs python: mq(request.form, sort_on='status')"
                      href="" tal:attributes="href string:manage_transactions?${qs}">Status</a>
               </td>
               <td class="list-item" align="right" tal:attributes="colspan python: journal and '2' or '1'">Amount</td>
               <td>&nbsp;</td>
               <td class="list-item">
                   <strong tal:condition="python: sort_on=='entered_by'">Entered By</strong>
                   <a tal:condition="python: sort_on != 'entered_by'"
                      tal:define="qs python: mq(request.form, sort_on='entered_by')"
                      href="" tal:attributes="href string:manage_transactions?${qs}">Entered By</a>
               </td>
               <td class="list-item">
                   <strong>Created</strong>
                   <a tal:condition="python: sort_on != 'created' or sort_order != 'descending'"
                      href="" tal:attributes="href python: 'manage_transactions?%s' % mq(request.form, sort_on='created', sort_order='descending')">&#9650;</a>
                   <a tal:condition="python: sort_on != 'created' or sort_order != 'ascending'"
                      tal:define="qs python: mq(request.form, sort_on='created', sort_order='ascending')"
                      href="" tal:attributes="href python: 'manage_transactions?%s' % mq(request.form, sort_on='created', sort_order='descending')">&#9660;</a>
	       </td>
               <td class="list-item">Last Modified</td>
     	       <td class="list-item" tal:define="n batch/next" align="right" nowrap>
                   <div tal:omit-tag="" tal:condition="n">
                      <a href="" 
                         tal:define="qs python: mq(request.form, entries_start=n.first)"
                         tal:attributes="href python: 'manage_transactions?%s' % qs">
                        &rarr;
                      </a>
                   </div>
                   <div tal:condition="not: n" tal:omit-tag="">&nbsp;</div>
              </td>
           </tr>
           <tr class="" 
               tal:repeat="item batch"
               tal:attributes="class python: repeat['item'].index % 2 and 'row-normal' or 'row-hilite'">
               <td class="list-item">
                  <input type="checkbox" name="ids:list" value="" tal:attributes="value item/getId">
               </td>
               <td class="list-item" width="50px" nowrap>
                   <a href="" border="0" tal:attributes="href string:${item/absolute_url}/manage_main">
                       <img src="" tal:attributes="src item/icon"/>
                   </a>
                   <img src="/misc_/BastionLedger/currency" title="Multi Currency"
                        tal:condition="item/isMultiCurrency | nothing"/>
                   <img src="trombone.gif" title="Attachments" tal:attributes="href string:${utool}/trombone.gif"
                        tal:condition="item/hasAttachments | nothing"/>
               </td>
               <td class="list-item" tal:content="python: item.effective().strftime('%Y-%m-%d %H:%M')"/>
               <td class="list-item" tal:define="txn_id python: journal and item.transactionId() or item.getId()">
		   <a href="" tal:condition="isLedger" tal:attributes="href string:${item/ledgerId}/${txn_id}/manage_main" tal:content="txn_id"/>
		   <a href="" tal:condition="not: isLedger" tal:attributes="href string:{txn_id}/manage_main" tal:content="txn_id"/>
	       </td>
               <td class="list-item" tal:condition="isLedger">
                  <a href="" 
                     tal:define="ledgerId item/ledgerId" 
                     tal:content="ledgerId" 
                     tal:attributes="href string:${ledgerId}/manage_workspace"/>
               </td>
               <td class="list-item" tal:condition="journal">
                   <a href="" tal:define="account python: item.blAccount()"
                              tal:attributes="href string:${account/absolute_url}/manage_main"
                              tal:content="account/Title"/> 
               </td>
               <td class="list-item">
                   <a href="" tal:define="obj python: journal and item.blTransaction() or item"
                              tal:attributes="href string:${obj/absolute_url}/manage_workspace"  
                              tal:content="item/Title"/>
               </td>
               <td class="list-item" tal:content="item/status"/>
               <td class="list-item" align="right"
                   tal:condition="not: journal"
                   tal:content="item/debitTotal" 
                   tal:on-error="string:????"/>
               <tal:journal tal:condition="journal">
                  <td class="list-item" align="right">
                     <span tal:condition="item/isDebit" tal:content="item/amount"/>
                  </td>
                  <td class="list-item" align="right">
                     <span tal:condition="item/isCredit" tal:content="item/absAmount"/>
                  </td>
               </tal:journal>
               <td>&nbsp;</td>
               <td class="list-item" tal:content="item/entered_by"/>
               <td class="list-item" 
                   tal:content="python: item.created().strftime('%Y-%m-%d %H:%M')"/>
               <td class="list-item" 
                   tal:content="python: item.bobobase_modification_time().strftime('%Y-%m-%d %H:%M')"/>
               <td>&nbsp;</td>
           </tr>
           <tr>
               <td colspan="11" tal:condition="not: journal">
                   <input class="form-element" type="submit"  value=" Reverse " name="manage_reverse:method"/>
                   <input class="form-element" type="submit"  value=" Cancel  " name="manage_cancel:method"/>
                   <input class="form-element" type="submit"  value="  Post   " name="manage_post:method"/>
                   <input class="form-element" type="submit"  value=" RePost  " name="manage_repost:method"/>
                   <input class="form-element" type="submit"  value=" Delete  " name="manage_delObjects:method"/>
                   <input class="form-element" type="submit"  value="  Merge  " name="manage_mergeTransactions:method"/>
                   <input class="form-element" type="submit"  value="  View   " name="manage_transactions:method"/>

                    &nbsp;&nbsp;
                  <input class="form-element" type="submit" name="selectButton" value="Select All"
                         onClick="toggleSelect(); return false" />

               </td>
           </tr>
       </table>
       </form>

    </tal:main>

<html tal:replace="structure context/manage_page_footer"/>





